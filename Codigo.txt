Cómo iniciar (simulación local con Docker)

1. Clonar el repo

2. (Opcional) Descargar OWASP CRS:

3. Levantar servicios:

docker-compose up -d --build
4. Verificar:
- App: `http://localhost:8080` → lista de usuarios.
- DB: `docker exec -it lab-db psql -U postgres -d seguridad_ciudadana -c "SELECT * FROM usuarios;"`

## Scripts para VMs (Perímetro / VPN)
Los scripts en `scripts/` están pensados para ejecutarse en VMs Ubuntu Server (no en contenedores).

**Referencia al Documento Maestro (Fase 3):**
`/mnt/data/Fase 3 Formulación del proceso metodológico investigativo - Grupo 202016907_71.pdf`

---

## Documentación adicional
Revisa `docs/resources.md` para enlaces a manuales (Tailscale, ModSecurity, PostgreSQL, UFW).

---

## Licencia
MIT License. (Archivo LICENSE)

docker-compose.yml
version: '3.8'
services:
  web:
    build: ./app
    container_name: lab-web
    depends_on:
      - db
    volumes:
      - ./app:/var/www/html
    networks:
      - labnet
    ports:
      - "8080:80"   # para pruebas locales
    restart: unless-stopped

  nginx-waf:
    image: nginx:1.22
    container_name: lab-nginx-waf
    depends_on:
      - web
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/sites-enabled/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/modsecurity:/etc/nginx/modsecurity:ro
      - ./nginx/modsecurity/crs:/etc/nginx/modsecurity/crs:ro
    ports:
      - "8081:80"   # WAF front-end (simulación)
    networks:
      - labnet
    restart: unless-stopped

  db:
    image: postgres:14
    container_name: lab-db
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
    volumes:
      - ./db/init_db.sql:/docker-entrypoint-initdb.d/init_db.sql:ro
    networks:
      - labnet
    restart: unless-stopped

networks:
  labnet:
    driver: bridge

app/Dockerfile
FROM php:8.1-fpm
RUN docker-php-ext-install pdo pdo_pgsql
WORKDIR /var/www/html
COPY . /var/www/html

app/index.php
<?php
// Simple app to list users from PostgreSQL
$host = getenv('DB_HOST') ?: 'db';
$db   = 'seguridad_ciudadana';
$user = 'postgres';
$pass = 'postgres';

try {
    $conn = pg_connect("host=$host dbname=$db user=$user password=$pass");
    if (!$conn) {
        throw new Exception("DB connection failed");
    }
    $res = pg_query($conn, "SELECT nombre_completo, correo, rol FROM usuarios");
} catch (Exception $e) {
    echo "<h2>Error: " . htmlentities($e->getMessage()) . "</h2>";
    exit;
}
?>
<!doctype html>
<html>
<head><meta charset="utf-8"><title>Listado Usuarios</title></head>
<body>
<h2>Listado de Usuarios Registrados</h2>
<table border="1" cellpadding="6">
<tr><th>Nombre</th><th>Correo</th><th>Rol</th></tr>
<?php while ($row = pg_fetch_assoc($res)) { ?>
  <tr>
    <td><?=htmlspecialchars($row['nombre_completo'])?></td>
    <td><?=htmlspecialchars($row['correo'])?></td>
    <td><?=htmlspecialchars($row['rol'])?></td>
  </tr>
<?php } ?>
</table>
</body>
</html>

db/init_db.sql
CREATE DATABASE seguridad_ciudadana;
\connect seguridad_ciudadana

CREATE TABLE usuarios (
    id SERIAL PRIMARY KEY,
    nombre_completo VARCHAR(100) NOT NULL,
    correo VARCHAR(100) UNIQUE NOT NULL,
    rol VARCHAR(50) NOT NULL,
    fecha_registro TIMESTAMP DEFAULT NOW()
);

INSERT INTO usuarios (nombre_completo, correo, rol) VALUES
('Carlos Pérez', 'cperez@demo.gov', 'Administrador'),
('Ana Gómez', 'agomez@demo.gov', 'Funcionario'),
('Luis Torres', 'ltorres@demo.gov', 'Ciudadano');

nginx/nginx.conf
user  nginx;
worker_processes  auto;
events { worker_connections 1024; }
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    # ModSecurity include (path depends on how you install CRS)
    include /etc/nginx/modsecurity/modsecurity.conf;
    include /etc/nginx/modsecurity/crs-setup.conf;
    include /etc/nginx/modsecurity/crs/rules/*.conf;

    server_tokens off;

    server {
        listen 80;
        server_name localhost;

        location / {
            proxy_pass http://web:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}

nginx/sites-enabled/default.conf
server {
    listen 80;
    server_name _;

    location / {
        proxy_pass http://web:80;
        proxy_set_header Host $host;
    }
}

nginx/modsecurity/modsecurity.conf
# Minimal ModSecurity config for simulation
# For production, use full modsecurity v3 or distro-provided config
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off
SecRule REQUEST_HEADERS:User-Agent "BadBot" "id:1001,phase:1,deny,status:403,msg:'Bad Bot UA'"

# Include OWASP CRS rules (if present)
IncludeOptional /etc/nginx/modsecurity/crs/*.conf

scripts/ufw-setup.sh
#!/bin/bash
# Script para configurar UFW en la VM perimetral (Edwin)
set -e

echo "[*] Actualizando paquetes..."
sudo apt update -y

echo "[*] Instalando UFW..."
sudo apt install -y ufw

echo "[*] Habilitando UFW y políticas base..."
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw logging on

echo "[*] Permitimos SSH únicamente desde la red Tailscale (100.0.0.0/8)"
sudo ufw delete allow 22/tcp || true
sudo ufw allow from 100.0.0.0/8 to any port 22 proto tcp

echo "[*] (Opcional) Si deseas permitir http desde la red interna:"
# sudo ufw allow from 100.0.0.0/8 to any port 80 proto tcp

echo "[*] Aplicando UFW..."
sudo ufw --force enable

echo "[*] Estado final:"
sudo ufw status verbose
Dale permiso de ejecución: chmod +x scripts/ufw-setup.sh

scripts/tailscale-install.sh
#!/bin/bash
# Script de ayuda para instalar tailscale en Ubuntu Server
# Nota: ejecutar en la VM (no dentro del contenedor)
set -e

echo "[*] Instalando Tailscale..."
curl -fsSL https://tailscale.com/install.sh | sh

echo "[*] Para conectar esta VM al Tailnet, ejecutar:"
echo "sudo tailscale up"
echo
echo "Si prefieres conectar automáticamente desde el administrador (Auth Key), ejecutar:"
echo "sudo tailscale up --auth-key=tskey-auth-XXXXXXXXXXXX"

scripts/post-deploy-checks.sh
#!/bin/bash
# Comprobaciones rápidas tras despliegue docker
echo "[*] Contenedores activos:"
docker-compose ps

echo "[*] Comprobando web (app):"
curl -sS http://localhost:8080 | head -n 20

echo "[*] Acceso a DB (select):"
docker exec -it lab-db psql -U postgres -d seguridad_ciudadana -c "select count(*) from usuarios;"
